"use strict";(()=>{var e={};e.id=550,e.ids=[550],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},8174:e=>{e.exports=require("stripe")},7202:e=>{e.exports=require("twilio")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},7168:(e,t,r)=>{r.r(t),r.d(t,{config:()=>S,default:()=>f,routeModule:()=>g});var s={};r.r(s),r.d(s,{config:()=>d,default:()=>b});var o=r(1802),i=r(7153),n=r(6249),a=r(8858),c=r(4860),u=r(1741);let l=null;try{l=r(7728)}catch(e){console.log("Firebase Admin not available, using local subscriber store only")}let d={api:{bodyParser:!1}};async function p(e){let t=[];for await(let r of e)t.push("string"==typeof r?Buffer.from(r):r);return Buffer.concat(t)}async function m(e,t,r){if(l)try{let s=l.getFirestoreAdmin(),o=await s.collection("users").where("email","==",e).limit(1).get();if(!o.empty){let e=o.docs[0];await e.ref.update({subscription:{status:r.status,stripeCustomerId:t,stripeSubscriptionId:r.subscriptionId||null,updatedAt:new Date().toISOString()}}),console.log(`Firebase user ${e.id} subscription updated`)}}catch(e){console.error("Error updating Firebase subscription:",e.message)}}async function b(e,t){let r;if("POST"!==e.method)return t.setHeader("Allow","POST"),t.status(405).json({error:"Method not allowed"});let s=e.headers["stripe-signature"];if(!s)return t.status(400).json({error:"Missing stripe-signature header"});try{let t=await p(e);r=(0,a.verifyWebhookSignature)(t,s)}catch(e){return console.error("Webhook signature verification failed:",e.message),t.status(400).json({error:`Webhook Error: ${e.message}`})}console.log(`Received Stripe event: ${r.type}`);try{switch(r.type){case"checkout.session.completed":{let e=r.data.object,t=await (0,a.getCheckoutSessionCustomer)(e.id);if(t){let r=e.metadata?.phone_number||e.customer_details?.phone||t.customerPhone;if(r){let e=(0,u.validatePhoneNumber)(r);e.valid?r=e.formatted:(console.warn("Invalid phone number format:",r),r=null)}let s=(0,c.addSubscriber)({stripeCustomerId:t.customerId,stripeSubscriptionId:t.subscriptionId,email:t.customerEmail,phoneNumber:r,minVolumeRatio:1.5});console.log("New subscriber added:",s.id),await m(t.customerEmail,t.customerId,{status:"active",subscriptionId:t.subscriptionId}),r&&await (0,u.sendWelcomeMessage)(r)}break}case"customer.subscription.updated":{let e=r.data.object,t=e.customer,s=e.status;if("active"===e.status?((0,c.updateSubscriberStatus)(t,"active"),console.log(`Subscription activated for customer: ${t}`)):"past_due"===e.status?((0,c.updateSubscriberStatus)(t,"past_due"),console.log(`Subscription past due for customer: ${t}`)):"unpaid"===e.status&&((0,c.updateSubscriberStatus)(t,"unpaid"),console.log(`Subscription unpaid for customer: ${t}`)),l)try{let r=await l.getUserByStripeCustomerId(t);r.success&&await l.updateSubscriptionAdmin(r.uid,{status:s,stripeCustomerId:t,stripeSubscriptionId:e.id,updatedAt:new Date().toISOString()})}catch(e){console.error("Error updating Firebase on subscription update:",e.message)}break}case"customer.subscription.deleted":{let e=r.data.object.customer;if((0,c.removeSubscriber)(e),console.log(`Subscription cancelled for customer: ${e}`),l)try{let t=await l.getUserByStripeCustomerId(e);t.success&&await l.updateSubscriptionAdmin(t.uid,{status:"cancelled",stripeCustomerId:e,stripeSubscriptionId:null,updatedAt:new Date().toISOString()})}catch(e){console.error("Error updating Firebase on subscription cancel:",e.message)}break}case"invoice.payment_failed":{let e=r.data.object.customer;(0,c.updateSubscriberStatus)(e,"payment_failed"),console.log(`Payment failed for customer: ${e}`);break}case"invoice.payment_succeeded":{let e=r.data.object.customer;(0,c.updateSubscriberStatus)(e,"active"),console.log(`Payment succeeded for customer: ${e}`);break}default:console.log(`Unhandled event type: ${r.type}`)}t.status(200).json({received:!0})}catch(e){console.error("Error processing webhook:",e),t.status(500).json({error:"Internal server error"})}}let f=(0,n.l)(s,"default"),S=(0,n.l)(s,"config"),g=new o.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/stripe-webhook",pathname:"/api/stripe-webhook",bundlePath:"",filename:""},userland:s})},7728:(e,t,r)=>{r.r(t),r.d(t,{default:()=>m,getActiveSubscribersAdmin:()=>p,getFirestoreAdmin:()=>u,getUser:()=>a,getUserByEmail:()=>c,getUserByStripeCustomerId:()=>d,updateSubscriptionAdmin:()=>l,verifyIdToken:()=>n});let s=require("firebase-admin");var o=r.n(s);function i(){if(0===o().apps.length){let e=process.env.FIREBASE_SERVICE_ACCOUNT_KEY;if(e)try{let t=JSON.parse(e);o().initializeApp({credential:o().credential.cert(t),projectId:process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID})}catch(e){console.error("Error parsing Firebase service account:",e),o().initializeApp({credential:o().credential.applicationDefault(),projectId:process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID})}else o().initializeApp({credential:o().credential.applicationDefault(),projectId:process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID})}return o()}async function n(e){try{let t=i(),r=await t.auth().verifyIdToken(e);return{success:!0,uid:r.uid,email:r.email}}catch(e){return console.error("Token verification error:",e),{success:!1,error:e.message}}}async function a(e){try{let t=i(),r=await t.auth().getUser(e);return{success:!0,user:r}}catch(e){return console.error("Get user error:",e),{success:!1,error:e.message}}}async function c(e){try{let t=i(),r=await t.auth().getUserByEmail(e);return{success:!0,user:r}}catch(e){return console.error("Get user by email error:",e),{success:!1,error:e.message}}}function u(){return i().firestore()}async function l(e,t){try{let r=u();return await r.collection("users").doc(e).update({subscription:t,updatedAt:o().firestore.FieldValue.serverTimestamp()}),{success:!0}}catch(e){return console.error("Update subscription error:",e),{success:!1,error:e.message}}}async function d(e){try{let t=u(),r=await t.collection("users").where("subscription.stripeCustomerId","==",e).limit(1).get();if(r.empty)return{success:!1,error:"User not found"};let s=r.docs[0];return{success:!0,uid:s.id,data:s.data()}}catch(e){return console.error("Get user by Stripe ID error:",e),{success:!1,error:e.message}}}async function p(){try{let e=u(),t=await e.collection("users").where("subscription.status","==","active").get(),r=[];return t.forEach(e=>{let t=e.data();t.phoneNumber&&r.push({uid:e.id,email:t.email,phoneNumber:t.phoneNumber,preferences:t.preferences||{},stripeCustomerId:t.subscription?.stripeCustomerId})}),{success:!0,subscribers:r}}catch(e){return console.error("Get active subscribers error:",e),{success:!1,error:e.message,subscribers:[]}}}let m=i},8858:(e,t,r)=>{let s=r(8174),o=()=>{let e=process.env.STRIPE_SECRET_KEY;if(!e)throw Error("Stripe secret key not configured");return new s(e)};async function i(e){try{let t=o();return await t.customers.retrieve(e)}catch(e){return console.error("Failed to retrieve customer:",e.message),null}}async function n(e){try{let t=o();return await t.subscriptions.retrieve(e)}catch(e){return console.error("Failed to retrieve subscription:",e.message),null}}async function a(e){let t=await n(e);return!!t&&["active","trialing"].includes(t.status)}async function c(e){try{let t=o(),r=await t.checkout.sessions.retrieve(e,{expand:["customer","subscription"]});return{customerId:r.customer?.id,customerEmail:r.customer_details?.email||r.customer?.email,customerPhone:r.customer_details?.phone,subscriptionId:r.subscription?.id,subscriptionStatus:r.subscription?.status}}catch(e){return console.error("Failed to retrieve checkout session:",e.message),null}}async function u(e){try{let t=o();return(await t.subscriptions.list({status:"active",price:e,limit:100,expand:["data.customer"]})).data.map(e=>({subscriptionId:e.id,customerId:e.customer.id,customerEmail:e.customer.email,customerPhone:e.customer.phone,status:e.status,currentPeriodEnd:new Date(1e3*e.current_period_end)}))}catch(e){return console.error("Failed to list subscriptions:",e.message),[]}}e.exports={getStripeClient:o,verifyWebhookSignature:function(e,t){let r=o(),s=process.env.STRIPE_WEBHOOK_SECRET;if(!s)throw Error("Stripe webhook secret not configured");try{return r.webhooks.constructEvent(e,t,s)}catch(e){throw console.error("Webhook signature verification failed:",e.message),e}},getCustomer:i,getSubscription:n,isSubscriptionActive:a,getCheckoutSessionCustomer:c,listActiveSubscriptions:u}},4860:(e,t,r)=>{let s=r(2048),o=r(5315),i=o.join(process.cwd(),"data","subscribers.json");function n(){let e=o.dirname(i);s.existsSync(e)||s.mkdirSync(e,{recursive:!0}),s.existsSync(i)||s.writeFileSync(i,JSON.stringify({subscribers:[]},null,2))}function a(){try{n();let e=s.readFileSync(i,"utf8");return JSON.parse(e).subscribers||[]}catch(e){return console.error("Error loading subscribers:",e.message),[]}}function c(e){try{return n(),s.writeFileSync(i,JSON.stringify({subscribers:e},null,2)),!0}catch(e){return console.error("Error saving subscribers:",e.message),!1}}e.exports={addSubscriber:function(e){let t=a(),r=t.findIndex(t=>t.stripeCustomerId===e.stripeCustomerId||t.phoneNumber===e.phoneNumber),s={id:e.stripeCustomerId||`sub_${Date.now()}`,stripeCustomerId:e.stripeCustomerId,stripeSubscriptionId:e.stripeSubscriptionId,email:e.email,phoneNumber:e.phoneNumber,status:"active",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),preferences:{minVolumeRatio:e.minVolumeRatio||1.5,watchlist:e.watchlist||[],alertTime:e.alertTime||"09:00",maxAlertsPerDay:e.maxAlertsPerDay||5},alertsSent:0,lastAlertAt:null};return r>=0?t[r]={...t[r],...s,createdAt:t[r].createdAt,alertsSent:t[r].alertsSent}:t.push(s),c(t),s},updateSubscriberStatus:function(e,t){let r=a(),s=r.findIndex(t=>t.stripeCustomerId===e);return s>=0?(r[s].status=t,r[s].updatedAt=new Date().toISOString(),c(r),r[s]):null},updateSubscriberPreferences:function(e,t){let r=a(),s=r.findIndex(t=>t.stripeCustomerId===e);return s>=0?(r[s].preferences={...r[s].preferences,...t},r[s].updatedAt=new Date().toISOString(),c(r),r[s]):null},getActiveSubscribers:function(){return a().filter(e=>"active"===e.status)},getSubscriberByCustomerId:function(e){return a().find(t=>t.stripeCustomerId===e)},getSubscriberByPhone:function(e){return a().find(t=>t.phoneNumber===e)},recordAlertSent:function(e){let t=a(),r=t.findIndex(t=>t.stripeCustomerId===e);return r>=0?(t[r].alertsSent+=1,t[r].lastAlertAt=new Date().toISOString(),c(t),t[r]):null},removeSubscriber:function(e){let t=a(),r=t.findIndex(t=>t.stripeCustomerId===e);return r>=0&&(t[r].status="cancelled",t[r].updatedAt=new Date().toISOString(),c(t),!0)},loadSubscribers:a}},1741:(e,t,r)=>{let s=r(7202),o=()=>{let e=process.env.TWILIO_ACCOUNT_SID,t=process.env.TWILIO_AUTH_TOKEN;if(!e||!t)throw Error("Twilio credentials not configured");return s(e,t)};async function i(e,t,r,s){try{let i=o(),n=process.env.TWILIO_PHONE_NUMBER;if(!n)throw Error("Twilio phone number not configured");let a=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",notation:"compact",maximumFractionDigits:1}).format(s),c=await i.messages.create({body:`ðŸ”¥ KAHF Alert: ${t} showing ${r}x dark pool volume ratio (${a} total value). Check scanner for details.`,from:n,to:e});return console.log(`SMS sent to ${e}: ${c.sid}`),{success:!0,messageId:c.sid}}catch(t){return console.error(`Failed to send SMS to ${e}:`,t.message),{success:!1,error:t.message}}}async function n(e,t){let r=[];for(let s of e)for(let e of t.filter(e=>!(s.minVolumeRatio&&parseFloat(e.volumeRatio)<s.minVolumeRatio)&&(!s.watchlist||!(s.watchlist.length>0)||s.watchlist.includes(e.ticker))).slice(0,3)){let t=await i(s.phoneNumber,e.ticker,e.volumeRatio,e.totalValue);r.push({subscriberId:s.id,ticker:e.ticker,...t}),await new Promise(e=>setTimeout(e,200))}return r}async function a(e){try{let t=o(),r=process.env.TWILIO_PHONE_NUMBER,s=await t.messages.create({body:`Welcome to VolAlert Pro! ðŸš€ You'll receive SMS alerts when dark pool activity spikes above normal levels. Reply STOP to unsubscribe.`,from:r,to:e});return console.log(`Welcome SMS sent to ${e}: ${s.sid}`),{success:!0,messageId:s.sid}}catch(t){return console.error(`Failed to send welcome SMS to ${e}:`,t.message),{success:!1,error:t.message}}}e.exports={sendDarkPoolAlert:i,sendBatchAlerts:n,sendWelcomeMessage:a,validatePhoneNumber:function(e){let t=e.replace(/[^\d+]/g,"");return t.startsWith("+1")&&12===t.length?{valid:!0,formatted:t}:/^\d{10}$/.test(t)?{valid:!0,formatted:`+1${t}`}:t.startsWith("1")&&11===t.length?{valid:!0,formatted:`+${t}`}:{valid:!1,formatted:null}}}},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=7168);module.exports=r})();