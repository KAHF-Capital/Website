"use strict";(()=>{var e={};e.id=906,e.ids=[906],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7202:e=>{e.exports=require("twilio")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},2735:(e,t,r)=>{r.r(t),r.d(t,{config:()=>b,default:()=>S,routeModule:()=>g});var s={};r.r(s),r.d(s,{default:()=>p});var o=r(1802),n=r(7153),i=r(6249),a=r(4860),l=r(1741),c=r(2048),u=r.n(c),d=r(5315),m=r.n(d);let f=process.env.CRON_SECRET;async function p(e,t){if("POST"!==e.method)return t.setHeader("Allow","POST"),t.status(405).json({error:"Method not allowed"});let r=e.headers.authorization,s=r?.replace("Bearer ","");if(f&&s!==f)return console.warn("Unauthorized automated scanner request"),t.status(401).json({error:"Unauthorized"});try{let e=await h();if(!e||!e.tickers||0===e.tickers.length)return t.status(200).json({success:!0,message:"No dark pool data available",alertsSent:0});let r=e.tickers.filter(e=>"N/A"!==e.volume_ratio&&parseFloat(e.volume_ratio)>=1.5);if(0===r.length)return t.status(200).json({success:!0,message:"No high-activity tickers found",alertsSent:0});let s=(0,a.getActiveSubscribers)();if(0===s.length)return t.status(200).json({success:!0,message:"No active subscribers",alertsSent:0});console.log(`Found ${r.length} high-activity tickers`),console.log(`Sending alerts to ${s.length} subscribers`);let o=[];for(let e of s){if(!e.phoneNumber){console.warn(`Subscriber ${e.id} has no phone number`);continue}let t=e.preferences?.minVolumeRatio||1.5,s=e.preferences?.maxAlertsPerDay||5,n=e.preferences?.watchlist||[],i=r.filter(e=>parseFloat(e.volume_ratio)>=t);if(n.length>0){let e=i.filter(e=>n.includes(e.ticker)),t=i.filter(e=>!n.includes(e.ticker));i=[...e,...t]}for(let t of i=i.slice(0,s))try{let r=await (0,l.sendDarkPoolAlert)(e.phoneNumber,t.ticker,t.volume_ratio,t.total_value);r.success?((0,a.recordAlertSent)(e.stripeCustomerId),o.push({subscriberId:e.id,ticker:t.ticker,success:!0})):o.push({subscriberId:e.id,ticker:t.ticker,success:!1,error:r.error}),await new Promise(e=>setTimeout(e,250))}catch(r){console.error(`Failed to send alert to ${e.id}:`,r.message),o.push({subscriberId:e.id,ticker:t.ticker,success:!1,error:r.message})}}let n=o.filter(e=>e.success).length,i=o.filter(e=>!e.success).length;return console.log(`Alerts sent: ${n} success, ${i} failed`),t.status(200).json({success:!0,date:e.date,highActivityTickers:r.length,subscribersNotified:s.length,alertsSent:n,alertsFailed:i,results:o})}catch(e){return console.error("Automated scanner error:",e),t.status(500).json({success:!1,error:e.message})}}async function h(){try{let e=m().join(process.cwd(),"data","processed");if(!u().existsSync(e))return console.log("Processed data directory not found"),null;let t=u().readdirSync(e).filter(e=>e.endsWith(".json")&&/^\d{4}-\d{2}-\d{2}\.json$/.test(e)).sort().reverse();if(0===t.length)return console.log("No processed data files found"),null;let r=t[0],s=m().join(e,r),o=JSON.parse(u().readFileSync(s,"utf8"));return console.log(`Loaded dark pool data from ${r}`),{date:r.replace(".json",""),tickers:o.tickers||[],total_volume:o.total_volume||0}}catch(e){return console.error("Error loading dark pool data:",e),null}}let S=(0,i.l)(s,"default"),b=(0,i.l)(s,"config"),g=new o.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/automated-scanner",pathname:"/api/automated-scanner",bundlePath:"",filename:""},userland:s})},4860:(e,t,r)=>{let s=r(2048),o=r(5315),n=o.join(process.cwd(),"data","subscribers.json");function i(){let e=o.dirname(n);s.existsSync(e)||s.mkdirSync(e,{recursive:!0}),s.existsSync(n)||s.writeFileSync(n,JSON.stringify({subscribers:[]},null,2))}function a(){try{i();let e=s.readFileSync(n,"utf8");return JSON.parse(e).subscribers||[]}catch(e){return console.error("Error loading subscribers:",e.message),[]}}function l(e){try{return i(),s.writeFileSync(n,JSON.stringify({subscribers:e},null,2)),!0}catch(e){return console.error("Error saving subscribers:",e.message),!1}}e.exports={addSubscriber:function(e){let t=a(),r=t.findIndex(t=>t.stripeCustomerId===e.stripeCustomerId||t.phoneNumber===e.phoneNumber),s={id:e.stripeCustomerId||`sub_${Date.now()}`,stripeCustomerId:e.stripeCustomerId,stripeSubscriptionId:e.stripeSubscriptionId,email:e.email,phoneNumber:e.phoneNumber,status:"active",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),preferences:{minVolumeRatio:e.minVolumeRatio||1.5,watchlist:e.watchlist||[],alertTime:e.alertTime||"09:00",maxAlertsPerDay:e.maxAlertsPerDay||5},alertsSent:0,lastAlertAt:null};return r>=0?t[r]={...t[r],...s,createdAt:t[r].createdAt,alertsSent:t[r].alertsSent}:t.push(s),l(t),s},updateSubscriberStatus:function(e,t){let r=a(),s=r.findIndex(t=>t.stripeCustomerId===e);return s>=0?(r[s].status=t,r[s].updatedAt=new Date().toISOString(),l(r),r[s]):null},updateSubscriberPreferences:function(e,t){let r=a(),s=r.findIndex(t=>t.stripeCustomerId===e);return s>=0?(r[s].preferences={...r[s].preferences,...t},r[s].updatedAt=new Date().toISOString(),l(r),r[s]):null},getActiveSubscribers:function(){return a().filter(e=>"active"===e.status)},getSubscriberByCustomerId:function(e){return a().find(t=>t.stripeCustomerId===e)},getSubscriberByPhone:function(e){return a().find(t=>t.phoneNumber===e)},recordAlertSent:function(e){let t=a(),r=t.findIndex(t=>t.stripeCustomerId===e);return r>=0?(t[r].alertsSent+=1,t[r].lastAlertAt=new Date().toISOString(),l(t),t[r]):null},removeSubscriber:function(e){let t=a(),r=t.findIndex(t=>t.stripeCustomerId===e);return r>=0&&(t[r].status="cancelled",t[r].updatedAt=new Date().toISOString(),l(t),!0)},loadSubscribers:a}},1741:(e,t,r)=>{let s=r(7202),o=()=>{let e=process.env.TWILIO_ACCOUNT_SID,t=process.env.TWILIO_AUTH_TOKEN;if(!e||!t)throw Error("Twilio credentials not configured");return s(e,t)};async function n(e,t,r,s){try{let n=o(),i=process.env.TWILIO_PHONE_NUMBER;if(!i)throw Error("Twilio phone number not configured");let a=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",notation:"compact",maximumFractionDigits:1}).format(s),l=await n.messages.create({body:`ðŸ”¥ KAHF Alert: ${t} showing ${r}x dark pool volume ratio (${a} total value). Check scanner for details.`,from:i,to:e});return console.log(`SMS sent to ${e}: ${l.sid}`),{success:!0,messageId:l.sid}}catch(t){return console.error(`Failed to send SMS to ${e}:`,t.message),{success:!1,error:t.message}}}async function i(e,t){let r=[];for(let s of e)for(let e of t.filter(e=>!(s.minVolumeRatio&&parseFloat(e.volumeRatio)<s.minVolumeRatio)&&(!s.watchlist||!(s.watchlist.length>0)||s.watchlist.includes(e.ticker))).slice(0,3)){let t=await n(s.phoneNumber,e.ticker,e.volumeRatio,e.totalValue);r.push({subscriberId:s.id,ticker:e.ticker,...t}),await new Promise(e=>setTimeout(e,200))}return r}async function a(e){try{let t=o(),r=process.env.TWILIO_PHONE_NUMBER,s=await t.messages.create({body:`Welcome to VolAlert Pro! ðŸš€ You'll receive SMS alerts when dark pool activity spikes above normal levels. Reply STOP to unsubscribe.`,from:r,to:e});return console.log(`Welcome SMS sent to ${e}: ${s.sid}`),{success:!0,messageId:s.sid}}catch(t){return console.error(`Failed to send welcome SMS to ${e}:`,t.message),{success:!1,error:t.message}}}e.exports={sendDarkPoolAlert:n,sendBatchAlerts:i,sendWelcomeMessage:a,validatePhoneNumber:function(e){let t=e.replace(/[^\d+]/g,"");return t.startsWith("+1")&&12===t.length?{valid:!0,formatted:t}:/^\d{10}$/.test(t)?{valid:!0,formatted:`+1${t}`}:t.startsWith("1")&&11===t.length?{valid:!0,formatted:`+${t}`}:{valid:!1,formatted:null}}}},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=2735);module.exports=r})();