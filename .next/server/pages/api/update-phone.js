"use strict";(()=>{var e={};e.id=85,e.ids=[85],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7202:e=>{e.exports=require("twilio")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},421:(e,t,r)=>{r.r(t),r.d(t,{config:()=>b,default:()=>f,routeModule:()=>S});var s={};r.r(s),r.d(s,{default:()=>p});var n=r(1802),o=r(7153),i=r(6249),u=r(4860),a=r(1741),l=r(2048),c=r.n(l),d=r(5315);let m=r.n(d)().join(process.cwd(),"data","subscribers.json");async function p(e,t){if("POST"!==e.method)return t.setHeader("Allow","POST"),t.status(405).json({error:"Method not allowed"});let{customerId:r,phoneNumber:s,email:n}=e.body;if(!r)return t.status(400).json({error:"Missing customerId"});if(!s)return t.status(400).json({error:"Missing phoneNumber"});let o=(0,a.validatePhoneNumber)(s);if(!o.valid)return t.status(400).json({error:"Invalid phone number format. Please use a valid US phone number."});try{let e=(0,u.getSubscriberByCustomerId)(r);if(e){let e=(0,u.loadSubscribers)(),s=e.findIndex(e=>e.stripeCustomerId===r);if(s>=0)return e[s].phoneNumber=o.formatted,e[s].updatedAt=new Date().toISOString(),c().writeFileSync(m,JSON.stringify({subscribers:e},null,2)),await (0,a.sendWelcomeMessage)(o.formatted),t.status(200).json({success:!0,message:"Phone number updated successfully"})}return e=(0,u.addSubscriber)({stripeCustomerId:r,email:n,phoneNumber:o.formatted}),await (0,a.sendWelcomeMessage)(o.formatted),t.status(200).json({success:!0,message:"Subscriber registered successfully"})}catch(e){return console.error("Error updating phone number:",e),t.status(500).json({error:"Failed to update phone number"})}}let f=(0,i.l)(s,"default"),b=(0,i.l)(s,"config"),S=new n.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/update-phone",pathname:"/api/update-phone",bundlePath:"",filename:""},userland:s})},4860:(e,t,r)=>{let s=r(2048),n=r(5315),o=n.join(process.cwd(),"data","subscribers.json");function i(){let e=n.dirname(o);s.existsSync(e)||s.mkdirSync(e,{recursive:!0}),s.existsSync(o)||s.writeFileSync(o,JSON.stringify({subscribers:[]},null,2))}function u(){try{i();let e=s.readFileSync(o,"utf8");return JSON.parse(e).subscribers||[]}catch(e){return console.error("Error loading subscribers:",e.message),[]}}function a(e){try{return i(),s.writeFileSync(o,JSON.stringify({subscribers:e},null,2)),!0}catch(e){return console.error("Error saving subscribers:",e.message),!1}}e.exports={addSubscriber:function(e){let t=u(),r=t.findIndex(t=>t.stripeCustomerId===e.stripeCustomerId||t.phoneNumber===e.phoneNumber),s={id:e.stripeCustomerId||`sub_${Date.now()}`,stripeCustomerId:e.stripeCustomerId,stripeSubscriptionId:e.stripeSubscriptionId,email:e.email,phoneNumber:e.phoneNumber,status:"active",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),preferences:{minVolumeRatio:e.minVolumeRatio||1.5,watchlist:e.watchlist||[],alertTime:e.alertTime||"09:00",maxAlertsPerDay:e.maxAlertsPerDay||5},alertsSent:0,lastAlertAt:null};return r>=0?t[r]={...t[r],...s,createdAt:t[r].createdAt,alertsSent:t[r].alertsSent}:t.push(s),a(t),s},updateSubscriberStatus:function(e,t){let r=u(),s=r.findIndex(t=>t.stripeCustomerId===e);return s>=0?(r[s].status=t,r[s].updatedAt=new Date().toISOString(),a(r),r[s]):null},updateSubscriberPreferences:function(e,t){let r=u(),s=r.findIndex(t=>t.stripeCustomerId===e);return s>=0?(r[s].preferences={...r[s].preferences,...t},r[s].updatedAt=new Date().toISOString(),a(r),r[s]):null},getActiveSubscribers:function(){return u().filter(e=>"active"===e.status)},getSubscriberByCustomerId:function(e){return u().find(t=>t.stripeCustomerId===e)},getSubscriberByPhone:function(e){return u().find(t=>t.phoneNumber===e)},recordAlertSent:function(e){let t=u(),r=t.findIndex(t=>t.stripeCustomerId===e);return r>=0?(t[r].alertsSent+=1,t[r].lastAlertAt=new Date().toISOString(),a(t),t[r]):null},removeSubscriber:function(e){let t=u(),r=t.findIndex(t=>t.stripeCustomerId===e);return r>=0&&(t[r].status="cancelled",t[r].updatedAt=new Date().toISOString(),a(t),!0)},loadSubscribers:u}},1741:(e,t,r)=>{let s=r(7202),n=()=>{let e=process.env.TWILIO_ACCOUNT_SID,t=process.env.TWILIO_AUTH_TOKEN;if(!e||!t)throw Error("Twilio credentials not configured");return s(e,t)};async function o(e,t,r,s){try{let o=n(),i=process.env.TWILIO_PHONE_NUMBER;if(!i)throw Error("Twilio phone number not configured");let u=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",notation:"compact",maximumFractionDigits:1}).format(s),a=await o.messages.create({body:`ðŸ”¥ KAHF Alert: ${t} showing ${r}x dark pool volume ratio (${u} total value). Check scanner for details.`,from:i,to:e});return console.log(`SMS sent to ${e}: ${a.sid}`),{success:!0,messageId:a.sid}}catch(t){return console.error(`Failed to send SMS to ${e}:`,t.message),{success:!1,error:t.message}}}async function i(e,t){let r=[];for(let s of e)for(let e of t.filter(e=>!(s.minVolumeRatio&&parseFloat(e.volumeRatio)<s.minVolumeRatio)&&(!s.watchlist||!(s.watchlist.length>0)||s.watchlist.includes(e.ticker))).slice(0,3)){let t=await o(s.phoneNumber,e.ticker,e.volumeRatio,e.totalValue);r.push({subscriberId:s.id,ticker:e.ticker,...t}),await new Promise(e=>setTimeout(e,200))}return r}async function u(e){try{let t=n(),r=process.env.TWILIO_PHONE_NUMBER,s=await t.messages.create({body:`Welcome to VolAlert Pro! ðŸš€ You'll receive SMS alerts when dark pool activity spikes above normal levels. Reply STOP to unsubscribe.`,from:r,to:e});return console.log(`Welcome SMS sent to ${e}: ${s.sid}`),{success:!0,messageId:s.sid}}catch(t){return console.error(`Failed to send welcome SMS to ${e}:`,t.message),{success:!1,error:t.message}}}e.exports={sendDarkPoolAlert:o,sendBatchAlerts:i,sendWelcomeMessage:u,validatePhoneNumber:function(e){let t=e.replace(/[^\d+]/g,"");return t.startsWith("+1")&&12===t.length?{valid:!0,formatted:t}:/^\d{10}$/.test(t)?{valid:!0,formatted:`+1${t}`}:t.startsWith("1")&&11===t.length?{valid:!0,formatted:`+${t}`}:{valid:!1,formatted:null}}}},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=421);module.exports=r})();