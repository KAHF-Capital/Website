"use strict";(()=>{var e={};e.id=477,e.ids=[477],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},4809:e=>{e.exports=require("node-fetch")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},5010:(e,t,r)=>{r.r(t),r.d(t,{config:()=>P,default:()=>w,routeModule:()=>y});var a={};r.r(a),r.d(a,{default:()=>g});var o=r(1802),i=r(7153),n=r(6249),s=r(4809),l=r.n(s);let c="https://query2.finance.yahoo.com/v7/finance/options",u={maxConcurrent:parseInt(process.env.YAHOO_MAX_CONCURRENT)||3,delayBetweenBatches:parseInt(process.env.YAHOO_BATCH_DELAY)||2e3,requestTimeout:parseInt(process.env.YAHOO_REQUEST_TIMEOUT)||1e4,maxRetries:parseInt(process.env.YAHOO_MAX_RETRIES)||2},h=new Map;async function p(e){try{let t=`https://query1.finance.yahoo.com/v8/finance/chart/${e}`,r=await l()(t,{timeout:u.requestTimeout});if(!r.ok)throw Error(`HTTP ${r.status}`);let a=await r.json();if(!a.chart?.result?.[0])throw Error("No price data available");let o=a.chart.result[0];return{price:o.meta.regularMarketPrice,currency:o.meta.currency,exchange:o.meta.exchangeName}}catch(t){throw console.error(`Error fetching price for ${e}:`,t.message),t}}async function f(e,t){let r=`${e}-${t}`,a=Date.now();if(h.has(r)){let e=h.get(r);if(a-e.timestamp<3e5)return e.data}try{let o=await l()(`${c}/${e}`,{timeout:u.requestTimeout});if(!o.ok)throw Error(`Expirations API error: ${o.status}`);let i=await o.json();if(!i.optionChain?.result?.[0])throw Error("No options chain available");let n=i.optionChain.result[0].expirationDates||[];if(0===n.length)throw Error("No expiration dates available");let s=null;if(n.length>0){let e=new Date;e.setDate(e.getDate()+30),s=n[0];let t=1/0;n.forEach(r=>{let a=new Date(1e3*r),o=Math.abs(a-e);o<t&&(t=o,s=r)})}if(!s)throw Error("No expiration dates available");let p=await l()(`${c}/${e}?date=${s}`,{timeout:u.requestTimeout});if(!p.ok)throw Error(`Options API error: ${p.status}`);let f=await p.json();if(!f.optionChain?.result?.[0])throw Error("No options data available");let d=f.optionChain.result[0],m=d.options[0]?.calls||[],g=d.options[0]?.puts||[];if(0===m.length||0===g.length)throw Error("No options contracts available");let w=null,P=1/0;if(m.forEach(e=>{let r=Math.abs(e.strike-t);r<P&&(P=r,w=e.strike)}),!w)throw Error("Could not find ATM strike");let y=m.find(e=>e.strike===w),A=g.find(e=>e.strike===w);if(!y||!A)throw Error("Could not find ATM call and put options");let E=(y.bid+y.ask)/2,k=(A.bid+A.ask)/2,b={ticker:e,currentPrice:t,strikePrice:w,totalPremium:E+k,callBid:y.bid,callAsk:y.ask,putBid:A.bid,putAsk:A.ask,expirationDate:new Date(1e3*s).toISOString().split("T")[0],source:"yahoo_finance",dataQuality:"high"};return h.set(r,{data:b,timestamp:a}),b}catch(t){throw console.error(`Error fetching options data for ${e}:`,t.message),t}}async function d(e,t=u.maxRetries){for(let r=1;r<=t;r++)try{let t=(await p(e)).price;try{let r=await f(e,t);return{ticker:e,currentPrice:t,strikePrice:r.strikePrice,totalPremium:r.totalPremium,source:"yahoo_finance",dataQuality:"high",expirationDate:r.expirationDate,callBid:r.callBid,callAsk:r.callAsk,putBid:r.putBid,putAsk:r.putAsk}}catch(a){console.warn(`Options data unavailable for ${e}, using estimation:`,a.message);let r=function(e,t=30){return Math.max(.3*e*Math.sqrt(t/365)*.4,.01*e)}(t);return{ticker:e,currentPrice:t,strikePrice:t,totalPremium:r,source:"estimation",dataQuality:"medium",note:"Options data unavailable, using estimation"}}}catch(a){if(console.error(`Attempt ${r} failed for ${e}:`,a.message),r===t)return{ticker:e,error:a.message,source:"error",dataQuality:"none"};await new Promise(e=>setTimeout(e,1e3*r))}}async function m(e){let t=[];for(let r=0;r<e.length;r+=u.maxConcurrent){let a=e.slice(r,r+u.maxConcurrent);console.log(`Processing batch ${Math.floor(r/u.maxConcurrent)+1}: ${a.map(e=>e.ticker).join(", ")}`);let o=a.map(e=>d(e.ticker)),i=await Promise.all(o);t.push(...i),r+u.maxConcurrent<e.length&&(console.log(`Waiting ${u.delayBetweenBatches}ms before next batch...`),await new Promise(e=>setTimeout(e,u.delayBetweenBatches)))}return t}async function g(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let{tickers:r}=e.body;if(!r||!Array.isArray(r)||0===r.length)return t.status(400).json({error:"Missing or invalid tickers array"});console.log(`Starting batch Yahoo Finance options fetch for ${r.length} tickers`);let a=Date.now(),o=await m(r),i=Date.now()-a,n=o.filter(e=>"yahoo_finance"===e.source).length,s=o.filter(e=>"estimation"===e.source).length,l=o.filter(e=>"error"===e.source).length;console.log(`Batch processing complete in ${i}ms: ${n} Yahoo Finance, ${s} estimated, ${l} errors`);let c={timestamp:new Date().toISOString(),config:u,totalTickers:r.length,processingTime:i,results:{yahooFinance:n,estimated:s,errors:l},data:o};return t.status(200).json(c)}catch(e){return console.error("Error in batch-yahoo-options API:",e),t.status(500).json({error:"Failed to process batch options data",details:"Please try again later"})}}let w=(0,n.l)(a,"default"),P=(0,n.l)(a,"config"),y=new o.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/batch-yahoo-options",pathname:"/api/batch-yahoo-options",bundlePath:"",filename:""},userland:a})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=5010);module.exports=r})();