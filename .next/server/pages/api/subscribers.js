"use strict";(()=>{var e={};e.id=671,e.ids=[671],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},350:(e,t,r)=>{r.r(t),r.d(t,{config:()=>m,default:()=>d,routeModule:()=>p});var s={};r.r(s),r.d(s,{default:()=>o});var n=r(1802),i=r(7153),u=r(6249),a=r(4860);async function o(e,t){let{method:r}=e;switch(r){case"GET":return l(e,t);case"PUT":return c(e,t);default:return t.setHeader("Allow",["GET","PUT"]),t.status(405).json({error:`Method ${r} not allowed`})}}async function l(e,t){let{customerId:r,phone:s,listAll:n}=e.query;if("true"===n){let r=process.env.ADMIN_SECRET,s=e.headers.authorization;if(!r||s!==`Bearer ${r}`)return t.status(401).json({error:"Unauthorized"});let n=(0,a.getActiveSubscribers)();return t.status(200).json({count:n.length,subscribers:n.map(e=>({id:e.id,email:e.email,phoneNumber:e.phoneNumber?`***${e.phoneNumber.slice(-4)}`:null,status:e.status,alertsSent:e.alertsSent,createdAt:e.createdAt}))})}let i=null;if(r)i=(0,a.getSubscriberByCustomerId)(r);else{if(!s)return t.status(400).json({error:"Missing customerId or phone parameter"});i=(0,a.getSubscriberByPhone)(s)}return i?t.status(200).json({id:i.id,email:i.email,status:i.status,preferences:i.preferences,alertsSent:i.alertsSent,lastAlertAt:i.lastAlertAt}):t.status(404).json({error:"Subscriber not found"})}async function c(e,t){let{customerId:r}=e.query,{preferences:s}=e.body;if(!r)return t.status(400).json({error:"Missing customerId parameter"});if(!s)return t.status(400).json({error:"Missing preferences in request body"});let n={};"number"==typeof s.minVolumeRatio&&(n.minVolumeRatio=Math.max(1,Math.min(10,s.minVolumeRatio))),Array.isArray(s.watchlist)&&(n.watchlist=s.watchlist.filter(e=>"string"==typeof e).map(e=>e.toUpperCase().trim()).filter(e=>/^[A-Z]{1,5}$/.test(e)).slice(0,20)),"number"==typeof s.maxAlertsPerDay&&(n.maxAlertsPerDay=Math.max(1,Math.min(10,s.maxAlertsPerDay))),"string"==typeof s.alertTime&&/^\d{2}:\d{2}$/.test(s.alertTime)&&(n.alertTime=s.alertTime);let i=(0,a.updateSubscriberPreferences)(r,n);return i?t.status(200).json({success:!0,preferences:i.preferences}):t.status(404).json({error:"Subscriber not found"})}let d=(0,u.l)(s,"default"),m=(0,u.l)(s,"config"),p=new n.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/subscribers",pathname:"/api/subscribers",bundlePath:"",filename:""},userland:s})},4860:(e,t,r)=>{let s=r(2048),n=r(5315),i=n.join(process.cwd(),"data","subscribers.json");function u(){let e=n.dirname(i);s.existsSync(e)||s.mkdirSync(e,{recursive:!0}),s.existsSync(i)||s.writeFileSync(i,JSON.stringify({subscribers:[]},null,2))}function a(){try{u();let e=s.readFileSync(i,"utf8");return JSON.parse(e).subscribers||[]}catch(e){return console.error("Error loading subscribers:",e.message),[]}}function o(e){try{return u(),s.writeFileSync(i,JSON.stringify({subscribers:e},null,2)),!0}catch(e){return console.error("Error saving subscribers:",e.message),!1}}e.exports={addSubscriber:function(e){let t=a(),r=t.findIndex(t=>t.stripeCustomerId===e.stripeCustomerId||t.phoneNumber===e.phoneNumber),s={id:e.stripeCustomerId||`sub_${Date.now()}`,stripeCustomerId:e.stripeCustomerId,stripeSubscriptionId:e.stripeSubscriptionId,email:e.email,phoneNumber:e.phoneNumber,status:"active",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),preferences:{minVolumeRatio:e.minVolumeRatio||1.5,watchlist:e.watchlist||[],alertTime:e.alertTime||"09:00",maxAlertsPerDay:e.maxAlertsPerDay||5},alertsSent:0,lastAlertAt:null};return r>=0?t[r]={...t[r],...s,createdAt:t[r].createdAt,alertsSent:t[r].alertsSent}:t.push(s),o(t),s},updateSubscriberStatus:function(e,t){let r=a(),s=r.findIndex(t=>t.stripeCustomerId===e);return s>=0?(r[s].status=t,r[s].updatedAt=new Date().toISOString(),o(r),r[s]):null},updateSubscriberPreferences:function(e,t){let r=a(),s=r.findIndex(t=>t.stripeCustomerId===e);return s>=0?(r[s].preferences={...r[s].preferences,...t},r[s].updatedAt=new Date().toISOString(),o(r),r[s]):null},getActiveSubscribers:function(){return a().filter(e=>"active"===e.status)},getSubscriberByCustomerId:function(e){return a().find(t=>t.stripeCustomerId===e)},getSubscriberByPhone:function(e){return a().find(t=>t.phoneNumber===e)},recordAlertSent:function(e){let t=a(),r=t.findIndex(t=>t.stripeCustomerId===e);return r>=0?(t[r].alertsSent+=1,t[r].lastAlertAt=new Date().toISOString(),o(t),t[r]):null},removeSubscriber:function(e){let t=a(),r=t.findIndex(t=>t.stripeCustomerId===e);return r>=0&&(t[r].status="cancelled",t[r].updatedAt=new Date().toISOString(),o(t),!0)},loadSubscribers:a}},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=350);module.exports=r})();